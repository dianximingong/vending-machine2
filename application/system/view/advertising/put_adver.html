<!DOCTYPE html>
<html lang="zh">
<head>
    {include file="../application/common/view/web/head.html" title=" - 广告管理"}
    <style>
        input[type=text].show-mch-no {
            border: none;
            background-color: transparent;
            width: 83px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        #machineList{
            scrollBar-face-color:green;
            scrollBar-hightLight-color:red;
            scrollBar-3dLight-color:orange;
            scrollBar-darkshadow-color:blue;
            scrollBar-shadow-color:yellow;
            scrollBar-arrow-color:purple;
            scrollBar-track-color:black;
            scrollBar-base-color:pink;
        }


    </style>
</head>
<!-- begin::Body -->
<body class="m-page--fluid m--skin- m-content--skin-light2 m-header--fixed m-header--fixed-mobile m-aside-left--enabled m-aside-left--skin-dark m-aside-left--fixed m-aside-left--offcanvas m-footer--push m-aside--offcanvas-default">
<!-- begin:: Page -->
<div class="m-grid m-grid--hor m-grid--root m-page">
    <!-- BEGIN: Header -->
    {include file="../application/common/view/web/header.html"}
    <!-- END: Header -->
    <!-- begin::Body -->
    <div class="m-grid__item m-grid__item--fluid m-grid m-grid--ver-desktop m-grid--desktop m-body">
        <!-- BEGIN: Left Aside -->
        {include file="../application/common/view/web/left.html"}
        <!-- END: Left Aside -->
        <div class="m-grid__item m-grid__item--fluid m-wrapper">
            <div class="m-subheader ">
                <div class="d-flex align-items-center">
                    <div class="mr-auto">
                        <h3 class="m-subheader__title m-subheader__title--separator">广告管理</h3>
                        <ul class="m-subheader__breadcrumbs m-nav m-nav--inline">
                            <li class="m-nav__item m-nav__item--home">
                                <a href="{:url('Index/index')}" class="m-nav__link m-nav__link--icon">
                                    <i class="m-nav__link-icon la la-home"></i>
                                </a>
                            </li>
                            <li class="m-nav__separator">-</li>
                            <li class="m-nav__item">
                                <a href="{:url('Adver/index')}" class="m-nav__link">
                                    <span class="m-nav__link-text">广告管理</span>
                                </a>
                            </li>
                            <li class="m-nav__separator">-</li>
                            <li class="m-nav__item">
                                <a href="{:url('Advertising/index')}" class="m-nav__link">
                                    <span class="m-nav__link-text">投放列表</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="m-content">
                <div class="row">
                    <div class="col-lg-3">

                        <!--begin::Portlet-->
                        <div class="m-portlet">
                            <div class="m-portlet__head">
                                <div class="m-portlet__head-caption">
                                    <div class="m-portlet__head-title">
												<span class="m-portlet__head-icon">
													<i class="flaticon-add"></i>
												</span>
                                        <h3 class="m-portlet__head-text">
                                           投放信息
                                        </h3>
                                    </div>
                                </div>
                            </div>
                            <form class="m-form m-form--fit m-form--label-align-right">
                                <div class="m-portlet__body">
                                    <div class="form-group m-form__group">
                                        <label >投放类型</label>
                                        <div class="m-form__control">
                                        <label class="m-radio m-radio--solid m-radio--success" style="line-height: 1.85em;margin-right: 2em;">
                                            <input type="radio" class="form-control" name="advType" value="1" checked> 不分屏
                                            <span></span>
                                        </label>
                                        <label class="m-radio m-radio--solid m-radio--success" style="line-height: 1.85em">
                                            <input type="radio" class="form-control" name="advType" value="2"> 分屏
                                            <span></span>
                                        </label>
                                        </div>
                                    </div>
                                    <div class="form-group m-form__group">
                                        <label for="adver">投放素材</label>
                                        <div class="m-form__control">
                                            <select class="form-control m-input m-input--solid" id="adver" multiple="multiple"></select>
                                        </div>
                                    </div>
                                    <div class="form-group m-form__group">
                                        <label for="exampleInputEmail1">投放区域</label>
                                        <select class="form-control m-input m-input--solid" id="exampleInputEmail1">
                                            <option>1</option>
                                            <option>2</option>
                                            <option>3</option>
                                            <option>4</option>
                                            <option>5</option>
                                        </select>
                                    </div>
                                    <div class="form-group m-form__group">
                                        <label>开始时间</label>
                                        <div class="m-form__control">
                                            <input type="text" class="form-control m-input m-input--solid" placeholder="开始时间" id="m_datetimepicker_4_3">
                                        </div>
                                    </div>
                                    <div class="form-group m-form__group">
                                        <label>结束时间</label>
                                        <div class="m-form__control">
                                            <input type="text" class="form-control m-input m-input--solid" placeholder="结束时间" id="m_datetimepicker_4_2">
                                        </div>
                                    </div>
                                </div>
                                <div class="m-portlet__foot m-portlet__foot--fit">
                                    <div class="m-form__actions">
                                        <button type="button" class="btn btn-success" id="putAdver">投放</button>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <!--end::Portlet-->
                    </div>
                    <div class="col-lg-9">

                        <!--begin::Portlet-->
                        <div class="m-portlet">
                            <div class="m-portlet__head">
                                <div class="m-portlet__head-caption">
                                    <div class="m-portlet__head-title">
												<span class="m-portlet__head-icon">
													<i class="flaticon-imac"></i>
												</span>
                                        <h3 class="m-portlet__head-text">
                                            机器选择
                                        </h3>
                                    </div>
                                </div>
                            </div>
                            <div class="m-portlet__body" id="machineList" style="height: 600px;overflow-y:auto;">
                                <div class="dataTables_wrapper">
                                    <table class="table table-striped- table-bordered table-hover table-checkable"
                                           id="m_table_1">
                                        <thead>
                                        <tr>
                                            <th class="text-center"><label class="m-checkbox m-checkbox--solid m-checkbox--success">
                                                <input type="checkbox" name="checkall">ID
                                                <span></span>
                                            </label></th>
                                            <th class="text-center">设备名称</th>
                                            <th class="text-center">设备号</th>
                                        </tr>
                                        </thead>
                                        <tbody id="machine_list">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!--end::Portlet-->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- end:: Body -->
    <!-- begin::Footer -->
    {include file="../application/common/view/web/footer.html"}
    <!-- end::Footer -->
</div>
<!-- end:: Page -->
{include file="../application/common/view/web/foot.html"}
<script src="/resource/web/assets/demo/default/custom/crud/forms/widgets/select2.js"  type="text/javascript"></script>
<script src="/resource/web/assets/demo/default/custom/crud/forms/widgets/bootstrap-datetimepicker.js" type="text/javascript"></script>
<!--<script src="/resource/web/assets/demo/default/custom/crud/metronic-datatable/base/record-selection.js" type="text/javascript"></script>-->

<script>
    nav_url = "{:url('advertising/index')}";
    $(function(){
        $("#adver").select2({
            placeholder: "请至少选择一个素材",
            tags:true,
            // maximumSelectionLength: 5,//限制最多选择个数
            createTag:function (decorated, params) {
                return null;
            },
            width:'100%',
        });

        /**
         * 全选、全不选
         */
        $('input[name="checkall"]').on("click",function(){
            if($(this).is(':checked')){
                $('input[name="checkbox"]').each(function(){
                    $(this).prop("checked",true);
                });
            }else{
                $('input[name="checkbox"]').each(function(){
                    $(this).prop("checked",false);
                });
            }
        });
        // $('input[name="checkbox"]').on("click",function(){
        //     console.log('12314556',$(this).val());
        // });
        $("#putAdver").click(function () {
            var resourceId = $("#adver").val();
            if (resourceId == '') {
                Swal.fire({
                    type: 'error',
                    title: '请选择投放素材',
                });
                return false;
            }
            var valArr = new Array;
            $("input[name='checkbox']:checkbox:checked").each(function (i) {
                valArr[i] = $(this).val();
            });
            var varArrLength = valArr.length;
            if (varArrLength == 0) {
                Swal.fire({
                    type: 'error',
                    title: '请选择投放机器',
                });
                return false;
            }
            var vals = valArr.join(',');
            var putType = $("input:radio[name='advType']:checked").val();
            var start_date = $("#m_datetimepicker_4_3").val();
            var end_date = $("#m_datetimepicker_4_2").val();
            if(start_date == ''){
                Swal.fire({
                    type: 'error',
                    title: '请选择开始时间',
                });
                return false;
            }
            if(end_date == ''){
                Swal.fire({
                    type: 'error',
                    title: '请选择结束时间',
                });
                return false;
            }
            $.ajax({
                url:"{:url('putAdverByMachine')}",
                type:"POST",
                data:{resourceId:resourceId,machineId:vals,putType:putType,start_date:start_date,end_date:end_date},
                success:function (resData){
                    console.log('resData',resData);
                    if(resData["state"] == 200){
                        Swal.fire({
                            position: 'top-end',
                            type: 'success',
                            title: resData["msg"],
                            showConfirmButton: false,
                            timer: 1500
                        });
                        setTimeout(function(){
                            window.location.href = "{:url('Advertising/index')}";
                        },1500);
                    }else{
                        Swal.fire({
                            type: 'error',
                            title: resData["msg"],
                        });
                    }
                },error:function (error) {
                    
                }
            });
            // console.log("start_date", start_date);
        });
        getAdverList(1);
        getMachineList(1);
        $("input:radio[name='advType']").change(function () {
            getAdverList($(this).val());
            getMachineList($(this).val());
        });
    });

    // $("#adver").change(function () {
    //     console.log("select2", $("#adver").val());
    // });

    function getAdverList(type) {
        $.ajax({
            url:"{:url('getAdverList')}",
            type:"POST",
            data:{type:type},
            success:function (resData) {
                if(resData["state"] == 200){
                    var adverData = resData["data"];
                    var adverListLength = resData["data"].length;
                    if(adverListLength == 0){
                        $("#adver").empty();
                        toastr.warning('素材未上传，请先上传该类型素材！');
                        return false;
                    }
                    $("#adver").empty();
                    for (var i=0;i<adverListLength;i++){
                        option = '<option value="'+adverData[i]["resource_id"]+'" >'+adverData[i]["resource_name"]+'</option>';
                        $("#adver").append(option);
                    }

                }else{
                    $("#adver").empty();
                    toastr.warning(resData["msg"]);
                }
            },error:function (error) {
                // console.log("error",error);
                $("#adver").empty();
                toastr.warning("网络异常，获取广告素材失败");
            }
        });
    }

    function getMachineList(type) {
        $.ajax({
            url:"{:url('getMachineList')}",
            type:"POST",
            data:{type:type},
            success:function (resData) {
                if(resData["state"] == 200){
                    // toastr.success(resData["msg"]);
                    var machineList = resData["data"];
                    var machineListLength = resData["data"].length;
                    if(machineListLength == 0){
                        toastr.warning('未搜索到机器');
                        $("#machine_list").empty();
                        return false;
                    }
                    // console.log('machineList',machineList);
                    $("#machine_list").empty();
                    for (var i=0;i<machineListLength;i++){
                        tdHtml = '                                  <tr>\n' +
                                '                                        <td class="text-center"><label class="m-checkbox m-checkbox--solid m-checkbox--success machine_id"><input type="checkbox" name="checkbox" value="'+machineList[i]["machine_id"]+'">'+machineList[i]["machine_id"]+'<span></span></label></td>\n'+
                            '                                            <td class="text-center">\n' +
                            '                                               '+machineList[i]["machine_name"]+'\n' +
                            '                                           </td>\n' +
                            '                                            <td class="text-center">'+machineList[i]["machine_code"]+'</td>\n' +
                            '                                        </tr>';
                        $("#machine_list").append(tdHtml);
                    }

                }else{
                    $("#machine_list").empty();
                    toastr.warning(resData["msg"]);
                }
            },error:function (error) {
                // console.log("error",error);
                $("#machine_list").empty();
                toastr.warning("网络异常，获取机器列表失败");
            }
        });
    }
</script>
</body>
<!-- end::Body -->
</html>