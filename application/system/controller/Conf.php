<?php/** * Created by PhpStorm. * User: Administrator * Date: 2018/4/12 0012 * Time: 16:48 */namespace app\system\controller;use app\common\model\ConfModel;use cache\GetCache;use EasyWeChat\Factory;use think\Db;use think\Request;class Conf extends Common{    /**     * 支付宝配置     */    public function alipay(){        $name = 'alipay';        if(Request::instance()->isPost()){            $conf_content = input('conf_content/a');            $result = ConfModel::setConf($name,$conf_content);            if(!$result) return returnState(100,'设置失败');            GetCache::closeCache($name);            return returnState(100,'设置成功');        }        return $this->fetch('',[            'info' => ConfModel::getConf($name)        ]);    }    /**     * 微信配置     */    public function wechat(){        $name = 'wechat';        if(Request::instance()->isPost()){            $conf_content = input('conf_content/a');            $file = request()->file('wechat_txt');            // 移动到框架应用根目录/public/uploads/ 目录下            if($file) $file->validate(['size'=>15678,'ext'=>'txt'])->move('./', $_FILES['wechat_txt']['name'], true);            $result = ConfModel::setConf($name,$conf_content);//            if(!$result) return returnState(100,'设置失败');//            return returnState(100,'设置成功');            if(!$result) return $this->error('设置失败');            return $this->success('设置成功');        }        return $this->fetch('',[            'info' => ConfModel::getConf($name)        ]);    }    /**     * 微信菜单设置     */    public function wechat_menu(){        $name = 'wechat_menu';        if(Request::instance()->isPost()){            $conf_content = input('post.conf_content/a');            $flag = ConfModel::setConf($name,$conf_content);            if(false !== $flag){                $app = Factory::officialAccount(GetCache::getCache('wechat'));                $app->menu->create($conf_content);                return returnState(200,'设置成功');            }else{                return returnState(100,'设置失败');            }        }        return $this->fetch('',[            'info' => json_encode(ConfModel::getConf($name)),        ]);    }    /**     * 微信支付设置     */    public function wechat_pay(){        $name = 'wechat_pay';        if(Request::instance()->isPost()){            $conf_content = input('conf_content/a');            // apiclient_cert            $file1 = request()->file('apiclient_cert');            if($file1) $file1->validate(['size'=>156788,'ext'=>'pem'])->move('./WxpayV3/cert/', $_FILES['wechat_txt']['name'], true);            // apiclient_key            $file2 = request()->file('apiclient_key');            if($file2) $file2->validate(['size'=>156788,'ext'=>'pem'])->move('./WxpayV3/cert/', $_FILES['wechat_txt']['name'], true);            $result = ConfModel::setConf($name,$conf_content);            if(!$result) return $this->error('设置失败');            GetCache::closeCache($name);            return $this->success('设置成功');        }        return $this->fetch('',[            'info' => ConfModel::getConf($name),        ]);    }    /**     * 微信关注回复     */    public function wechat_reply(){        $name = 'wechat_reply';        if(Request::instance()->isPost()){            $value = input('post.conf_content/a');            $handle = ConfModel::setConf($name,$value);            if(!$handle) return returnState(100,'设置失败');            GetCache::closeCache($name);            return returnState(200,'设置成功');        }        return $this->fetch('',[            'info' => ConfModel::getConf($name),        ]);    }}